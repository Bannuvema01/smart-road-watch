<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Road Watch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
header{background:#0f766e;color:white;padding:15px;text-align:center}
section{padding:20px}
button{padding:10px;background:#0d9488;color:white;border:none;border-radius:6px;cursor:pointer}
button:hover{background:#0f766e}
input,textarea,select{width:100%;padding:8px;margin:6px 0}
.hidden{display:none}
.card{background:white;padding:15px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1);margin-bottom:15px}
#map{height:300px;border-radius:10px;margin:10px 0}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px}
th{background:#ccfbf1}
</style>
</head>

<body>

<header>
<h2>Smart Road Watch</h2>
<p>Pothole Reporting System</p>
</header>

<!-- ROLE SELECTION -->
<section id="roleSelect">
<div class="card">
<h3>Select Role</h3>
<button onclick="openUser()">Report Pothole</button>
<button onclick="openAdmin()">Authority Login</button>
</div>
</section>

<!-- USER SECTION -->
<section id="userSection" class="hidden">
<div class="card">
<h3>Report a Pothole</h3>

<label>Upload Photo</label>
<input type="file" id="photo">

<label>Location (Area Name)</label>
<input type="text" id="location" readonly>

<button onclick="getLocation()">Use Current Location</button>

<div id="map"></div>

<label>Description</label>
<textarea id="desc"></textarea>

<button onclick="submitReport()">Submit Report</button>
<button onclick="logout()">Back</button>
</div>
</section>

<!-- ADMIN LOGIN -->
<section id="adminLogin" class="hidden">
<div class="card">
<h3>Authority Login</h3>

<label>Username</label>
<input type="text" id="adminUser">

<label>Password</label>
<input type="password" id="adminPass">

<button onclick="loginAdmin()">Login</button>
<button onclick="logout()">Back</button>
</div>
</section>

<!-- ADMIN DASHBOARD -->
<section id="adminDashboard" class="hidden">
<div class="card">
<h3>Reported Potholes</h3>

<table>
<thead>
<tr>
<th>Photo</th>
<th>Location</th>
<th>Description</th>
<th>Status</th>
<th>Update</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>

<button onclick="logout()">Logout</button>
</div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------- VARIABLES ---------- */
let reports=[];
let map=null;
let marker=null;

/* ---------- UI CONTROL ---------- */
function hideAll(){
document.getElementById("roleSelect").classList.add("hidden");
document.getElementById("userSection").classList.add("hidden");
document.getElementById("adminLogin").classList.add("hidden");
document.getElementById("adminDashboard").classList.add("hidden");
}

function openUser(){
hideAll();
document.getElementById("userSection").classList.remove("hidden");
setTimeout(initMap,300);
}

function openAdmin(){
hideAll();
document.getElementById("adminLogin").classList.remove("hidden");
}

function logout(){
hideAll();
document.getElementById("roleSelect").classList.remove("hidden");
}

/* ---------- MAP ---------- */
function initMap(){
if(map) return;

map = L.map("map").setView([20.5937,78.9629],15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(map);

marker = L.marker([20.5937,78.9629],{draggable:true}).addTo(map);
reverseGeocode(20.5937,78.9629);

map.on("click",e=>{
marker.setLatLng(e.latlng);
reverseGeocode(e.latlng.lat,e.latlng.lng);
});

marker.on("dragend",()=>{
const p=marker.getLatLng();
reverseGeocode(p.lat,p.lng);
});
}

function getLocation(){
navigator.geolocation.getCurrentPosition(pos=>{
const lat=pos.coords.latitude;
const lng=pos.coords.longitude;
map.setView([lat,lng],16);
marker.setLatLng([lat,lng]);
reverseGeocode(lat,lng);
});
}

/* ---------- REVERSE GEOCODING ---------- */
function reverseGeocode(lat,lng){
fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
.then(res=>res.json())
.then(data=>{
document.getElementById("location").value=data.display_name || "Unknown location";
});
}

/* ---------- SUBMIT REPORT ---------- */
function submitReport(){
const photo=document.getElementById("photo").files[0];
const location=document.getElementById("location").value.trim();
const desc=document.getElementById("desc").value.trim();

if(!photo || !location || !desc){
alert("Please fill all details");
return;
}

reports.push({
photo:URL.createObjectURL(photo),
location:location,
description:desc,
status:"Pending"
});

alert("Report submitted successfully");
document.getElementById("photo").value="";
document.getElementById("desc").value="";
}

/* ---------- ADMIN LOGIN ---------- */
function loginAdmin(){
const user=document.getElementById("adminUser").value.trim();
const pass=document.getElementById("adminPass").value.trim();

if(user==="authority" && pass==="road@123"){
hideAll();
document.getElementById("adminDashboard").classList.remove("hidden");
loadAdmin();
}else{
alert("Invalid credentials\nUsername: authority\nPassword: road@123");
}
}

/* ---------- ADMIN DASHBOARD ---------- */
function loadAdmin(){
const table=document.getElementById("adminTable");
table.innerHTML="";
reports.forEach((r,i)=>{
const row=document.createElement("tr");
row.innerHTML=`
<td><img src="${r.photo}" width="80"></td>
<td>${r.location}</td>
<td>${r.description}</td>
<td>${r.status}</td>
<td>
<select onchange="updateStatus(${i},this.value)">
<option ${r.status==="Pending"?"selected":""}>Pending</option>
<option ${r.status==="Fixed"?"selected":""}>Fixed</option>
</select>
</td>`;
table.appendChild(row);
});
}

function updateStatus(i,val){
reports[i].status=val;
loadAdmin();
}
</script>

</body>
</html>
